---
title: "Analyze ChromHMM bed files"
output: html_notebook
---

Load in functions
```{r}
library(tidyverse)
library(ChromatinCompare)
```
Set up annotations
```{r}
annotations <- load_annotations(build='mm10', type='gene_body')
```

```{r}
mm10_hindbrain_e11.5 <- bed9_importer(system.file('extdata','ENCFF195OWF.chr1.bed.gz',package='ChromatinCompare'), skip=0)
mm10_midbrain_e14.5 <- bed9_importer(system.file('extdata','ENCFF643NHA.chr1.bed.gz',package='ChromatinCompare'), skip=0)
# Intersect the regions we read in with the annotations
mm10_hindbrain_e11.5_anno = annotate_regions(
  regions = bed9_to_granges(mm10_hindbrain_e11.5),
  annotations = annotations,
  ignore.strand = TRUE,
  quiet = FALSE)

mm10_midbrain_e14.5_anno = annotate_regions(
  regions = bed9_to_granges(mm10_midbrain_e14.5),
  annotations = annotations,
  ignore.strand = TRUE,
  quiet = FALSE)

# capture classes
#classes <- retina_early_anno$name %>% unique %>% sort %>% data.frame() %>% magrittr::set_colnames('name')
# reorder classes
#classes$name <- forcats::as_factor(classes$name) %>% forcats::fct_relevel('10_Open_Chromatin', after = Inf)

# gene-wise query
geneWise_hindbrain <- mm10_hindbrain_e11.5_anno %>% 
  data.frame() %>% 
  group_by(annot.symbol, name) %>% 
  summarise(bp_covered = sum(as.numeric(width))) %>% 
  group_by(annot.symbol) %>%
  mutate(`Feature Ratio` = bp_covered/sum(bp_covered)) %>% 
  dplyr::select(-bp_covered) %>% 
  ungroup() %>% 
  group_by(annot.symbol, name) %>% 
  spread(name, `Feature Ratio`) %>%
  ungroup()
gene_vector <- geneWise_hindbrain$annot.symbol
geneWise_hindbrain <- geneWise_hindbrain %>% ungroup() %>% dplyr::select(-annot.symbol) %>% as.matrix() %>% magrittr::set_rownames(gene_vector) 
# replace na with zero
geneWise_hindbrain[is.na(geneWise_hindbrain)] <- 0 
geneWise_hindbrain <- geneWise_hindbrain[complete.cases(geneWise_hindbrain),]


###
# gene-wise query
geneWise_midbrain <- mm10_midbrain_e14.5_anno %>% 
  data.frame() %>% 
  group_by(annot.symbol, name) %>% 
  summarise(bp_covered = sum(as.numeric(width))) %>% 
  group_by(annot.symbol) %>%
  mutate(`Feature Ratio` = bp_covered/sum(bp_covered)) %>% 
  dplyr::select(-bp_covered) %>% 
  ungroup() %>% 
  group_by(annot.symbol, name) %>% 
  spread(name, `Feature Ratio`) %>%
  ungroup()
gene_vector <- geneWise_midbrain$annot.symbol
geneWise_midbrain <- geneWise_midbrain %>% ungroup() %>% dplyr::select(-annot.symbol) %>% as.matrix() %>% magrittr::set_rownames(gene_vector) 
# replace na with zero
geneWise_midbrain[is.na(geneWise_midbrain)] <- 0 
geneWise_midbrain <- geneWise_midbrain[complete.cases(geneWise_midbrain),]
```

Distance between two genes
```{r}
dist(rbind(geneWise_hindbrain[2,],geneWise_hindbrain[1,]))

gene_names <- row.names(geneWise_hindbrain)[!is.na(row.names(geneWise_hindbrain))]


distances <- c(1:length(gene_names))
for (i in 1:length(gene_names)){
  distances[i] <- dist(rbind(geneWise_hindbrain[gene_names[i],], geneWise_midbrain[gene_names[i],]))
}
gene_distances$`Euclidean Distance` <- distances
```

Pictures
```{r}
genes <- c('Terf1','Elk4','Ush2a','Sept2')
ggplot(geneWise_hindbrain[genes,] %>% 
         as.tibble() %>% 
         mutate(Gene = genes) %>% 
         gather(Class, Value, -Gene) %>% 
         mutate(Class= gsub('_',' ', x=Class) %>% forcats::fct_relevel(as.factor(.), '10 Open Chromatin', after = Inf)), 
       aes(x=Gene, fill=Class,y=Value)) + 
  scale_fill_viridis(option='viridis', discrete = TRUE) +
  geom_bar(stat='identity') + 
  
  theme_bw()
```

Superheat
```{r}
superheat(geneWise_hindbrain,
          pretty.order.rows = T,
          bottom.label.text.angle = 90,
          bottom.label.size = 0.5)
```
